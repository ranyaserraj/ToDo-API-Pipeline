const { 
  resetTasks, 
  getTasks, 
  addTask, 
  deleteTask, 
  getTaskById, 
  getTaskStats,
  completeTask,
  uncompleteTask,
  updateTask,
  searchTasks,
  sortTasks,
  exportTasks,
  importTasks,
  getCategories,
  clearCompletedTasks
} = require('./tasks');

describe('üß™ Tests Unitaires - Fonctions tasks.js', () => {
  beforeEach(() => {
    resetTasks();
  });

  describe('getTasks', () => {
    test('devrait retourner un tableau vide initialement', () => {
      const tasks = getTasks();
      expect(tasks).toEqual([]);
      expect(Array.isArray(tasks)).toBe(true);
    });

    test('devrait retourner une copie des t√¢ches', () => {
      addTask('Test task');
      const tasks1 = getTasks();
      const tasks2 = getTasks();
      expect(tasks1).not.toBe(tasks2); // Diff√©rentes r√©f√©rences
      expect(tasks1).toEqual(tasks2); // M√™me contenu
    });
  });

  describe('addTask', () => {
    test('devrait ajouter une t√¢che avec un ID auto-incr√©ment√©', () => {
      const task1 = addTask('Premi√®re t√¢che');
      const task2 = addTask('Deuxi√®me t√¢che');
      
      expect(task1.id).toBe(1);
      expect(task2.id).toBe(2);
      expect(task1.task).toBe('Premi√®re t√¢che');
      expect(task2.task).toBe('Deuxi√®me t√¢che');
      expect(task1.completed).toBe(false);
      expect(task1.createdAt).toBeDefined();
    });

    test('devrait trimmer les espaces', () => {
      const task = addTask('  T√¢che avec espaces  ');
      expect(task.task).toBe('T√¢che avec espaces');
    });

    test('devrait lever une erreur pour des param√®tres invalides', () => {
      expect(() => addTask('')).toThrow();
      expect(() => addTask(null)).toThrow();
      expect(() => addTask(undefined)).toThrow();
      expect(() => addTask(123)).toThrow();
    });
  });

  describe('deleteTask', () => {
    test('devrait supprimer une t√¢che existante', () => {
      addTask('T√¢che √† supprimer');
      const result = deleteTask(1);
      
      expect(result).toBe(true);
      expect(getTasks()).toHaveLength(0);
    });

    test('devrait retourner false pour une t√¢che inexistante', () => {
      const result = deleteTask(999);
      expect(result).toBe(false);
    });

    test('devrait lever une erreur pour des IDs invalides', () => {
      expect(() => deleteTask(0)).toThrow();
      expect(() => deleteTask(-1)).toThrow();
      expect(() => deleteTask('abc')).toThrow();
    });
  });

  describe('getTaskById', () => {
    test('devrait retourner une t√¢che existante', () => {
      addTask('T√¢che test');
      const task = getTaskById(1);
      
      expect(task).toBeDefined();
      expect(task.id).toBe(1);
      expect(task.task).toBe('T√¢che test');
    });

    test('devrait retourner null pour une t√¢che inexistante', () => {
      const task = getTaskById(999);
      expect(task).toBeNull();
    });
  });

  describe('getTaskStats', () => {
    test('devrait calculer les statistiques correctement', () => {
      addTask('T√¢che 1');
      addTask('T√¢che 2');
      addTask('T√¢che 3');
      
      const stats = getTaskStats();
      expect(stats.total).toBe(3);
      expect(stats.completed).toBe(0);
      expect(stats.pending).toBe(3);
      expect(stats.completionRate).toBe('0.00');
    });
  });

  describe('Priorit√©s et cat√©gories', () => {
    test('devrait cr√©er une t√¢che avec priorit√© et cat√©gorie', () => {
      const taskData = {
        task: 'T√¢che importante',
        priority: 'high',
        category: 'Travail'
      };
      
      const task = addTask(taskData);
      
      expect(task.task).toBe('T√¢che importante');
      expect(task.priority).toBe('high');
      expect(task.category).toBe('Travail');
      expect(task.completed).toBe(false);
    });

    test('devrait cr√©er une t√¢che avec date d\'√©ch√©ance', () => {
      const dueDate = '2024-12-31';
      const taskData = {
        task: 'T√¢che avec √©ch√©ance',
        dueDate: dueDate
      };
      
      const task = addTask(taskData);
      
      expect(task.dueDate).toBe(dueDate);
    });
  });

  describe('Marquage des t√¢ches', () => {
    test('devrait marquer une t√¢che comme compl√©t√©e', () => {
      const task = addTask('T√¢che √† compl√©ter');
      const result = completeTask(task.id);
      
      expect(result).toBeDefined();
      expect(result.completed).toBe(true);
      
      const updatedTask = getTaskById(task.id);
      expect(updatedTask.completed).toBe(true);
      expect(updatedTask.completedAt).toBeDefined();
    });

    test('devrait marquer une t√¢che comme non compl√©t√©e', () => {
      const task = addTask('T√¢che √† reprendre');
      completeTask(task.id);
      const result = uncompleteTask(task.id);
      
      expect(result).toBeDefined();
      expect(result.completed).toBe(false);
      
      const updatedTask = getTaskById(task.id);
      expect(updatedTask.completed).toBe(false);
      expect(updatedTask.completedAt).toBeUndefined();
    });
  });

  describe('Mise √† jour des t√¢ches', () => {
    test('devrait mettre √† jour une t√¢che', () => {
      const task = addTask('T√¢che originale');
      const updates = {
        task: 'T√¢che modifi√©e',
        priority: 'high',
        category: 'Important'
      };
      
      const updatedTask = updateTask(task.id, updates);
      
      expect(updatedTask).toBeDefined();
      expect(updatedTask.task).toBe('T√¢che modifi√©e');
      expect(updatedTask.priority).toBe('high');
      expect(updatedTask.category).toBe('Important');
      expect(updatedTask.updatedAt).toBeDefined();
    });
  });

  describe('Recherche et filtrage', () => {
    beforeEach(() => {
      addTask({ task: 'T√¢che importante', priority: 'high', category: 'Travail' });
      addTask({ task: 'T√¢che normale', priority: 'medium', category: 'Personnel' });
      addTask({ task: 'T√¢che simple', priority: 'low' });
    });

    test('devrait filtrer par statut de compl√©tion', () => {
      const task = getTasks()[0];
      completeTask(task.id);
      
      const completedTasks = searchTasks({ completed: true });
      const pendingTasks = searchTasks({ completed: false });
      
      expect(completedTasks).toHaveLength(1);
      expect(pendingTasks).toHaveLength(2);
    });

    test('devrait filtrer par priorit√©', () => {
      const highPriorityTasks = searchTasks({ priority: 'high' });
      const mediumPriorityTasks = searchTasks({ priority: 'medium' });
      
      expect(highPriorityTasks).toHaveLength(1);
      expect(mediumPriorityTasks).toHaveLength(1);
    });

    test('devrait filtrer par cat√©gorie', () => {
      const workTasks = searchTasks({ category: 'Travail' });
      const personalTasks = searchTasks({ category: 'Personnel' });
      
      expect(workTasks).toHaveLength(1);
      expect(personalTasks).toHaveLength(1);
    });

    test('devrait rechercher par texte', () => {
      const importantTasks = searchTasks({ search: 'importante' });
      const normalTasks = searchTasks({ search: 'normale' });
      
      expect(importantTasks).toHaveLength(1);
      expect(normalTasks).toHaveLength(1);
    });
  });

  describe('Tri des t√¢ches', () => {
    beforeEach(() => {
      addTask({ task: 'T√¢che A', priority: 'low' });
      addTask({ task: 'T√¢che B', priority: 'high' });
      addTask({ task: 'T√¢che C', priority: 'medium' });
    });

    test('devrait trier par priorit√©', () => {
      const tasks = getTasks();
      const sortedByPriority = sortTasks(tasks, 'priority', 'desc');
      
      expect(sortedByPriority[0].priority).toBe('high');
      expect(sortedByPriority[1].priority).toBe('medium');
      expect(sortedByPriority[2].priority).toBe('low');
    });

    test('devrait trier par date de cr√©ation', () => {
      const tasks = getTasks();
      const sortedByDate = sortTasks(tasks, 'createdAt', 'asc');
      
      // V√©rifier que le tri fonctionne (m√™me nombre de t√¢ches)
      expect(sortedByDate).toHaveLength(3);
      expect(sortedByDate[0]).toBeDefined();
      expect(sortedByDate[1]).toBeDefined();
      expect(sortedByDate[2]).toBeDefined();
    });
  });

  describe('Statistiques avanc√©es', () => {
    beforeEach(() => {
      addTask({ task: 'T√¢che 1', priority: 'high', category: 'Travail' });
      addTask({ task: 'T√¢che 2', priority: 'medium', category: 'Personnel' });
      addTask({ task: 'T√¢che 3', priority: 'low' });
      completeTask(1);
    });

    test('devrait calculer les statistiques compl√®tes', () => {
      const stats = getTaskStats();
      
      expect(stats.total).toBe(3);
      expect(stats.completed).toBe(1);
      expect(stats.pending).toBe(2);
      expect(stats.priorityStats.high).toBe(1);
      expect(stats.priorityStats.medium).toBe(1);
      expect(stats.priorityStats.low).toBe(1);
      expect(stats.categoryStats.Travail).toBe(1);
      expect(stats.categoryStats.Personnel).toBe(1);
    });
  });

  describe('Export/Import', () => {
    test('devrait exporter les t√¢ches en JSON', () => {
      addTask('T√¢che 1');
      addTask('T√¢che 2');
      
      const data = exportTasks();
      
      expect(data.tasks).toHaveLength(2);
      expect(data.exportedAt).toBeDefined();
      expect(data.version).toBe('1.0');
    });

    test('devrait importer des t√¢ches depuis JSON', () => {
      const jsonData = JSON.stringify({
        tasks: [
          { task: 'T√¢che import√©e 1', priority: 'high' },
          { task: 'T√¢che import√©e 2', priority: 'low' }
        ]
      });
      
      const result = importTasks(jsonData, false);
      
      expect(result.success).toBe(true);
      expect(result.imported).toBe(2);
      expect(getTasks()).toHaveLength(2);
    });

    test('devrait fusionner les t√¢ches lors de l\'import', () => {
      addTask('T√¢che existante');
      
      const jsonData = JSON.stringify({
        tasks: [{ task: 'T√¢che import√©e' }]
      });
      
      const result = importTasks(jsonData, true);
      
      expect(result.success).toBe(true);
      expect(result.imported).toBe(1);
      expect(getTasks()).toHaveLength(2);
    });
  });

  describe('Gestion des cat√©gories', () => {
    test('devrait r√©cup√©rer les cat√©gories uniques', () => {
      addTask({ task: 'T√¢che 1', category: 'Travail' });
      addTask({ task: 'T√¢che 2', category: 'Personnel' });
      addTask({ task: 'T√¢che 3', category: 'Travail' });
      
      const categories = getCategories();
      
      expect(categories).toHaveLength(2);
      expect(categories).toContain('Personnel');
      expect(categories).toContain('Travail');
    });
  });

  describe('Nettoyage des t√¢ches', () => {
    test('devrait supprimer toutes les t√¢ches compl√©t√©es', () => {
      addTask('T√¢che 1');
      addTask('T√¢che 2');
      addTask('T√¢che 3');
      
      completeTask(1);
      completeTask(2);
      
      const deletedCount = clearCompletedTasks();
      
      expect(deletedCount).toBe(2);
      expect(getTasks()).toHaveLength(1);
    });
  });
});
