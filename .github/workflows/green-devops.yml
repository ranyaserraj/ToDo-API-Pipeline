name: Green DevOps - Comparaison de performance Docker

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  baseline:
    name: ðŸŒ Build & Test - Image Baseline (Lourde)
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Build image baseline
      run: |
        echo "ðŸ”¨ Construction de l'image baseline (lourde)..."
        docker build -f Dockerfile.baseline -t app:baseline .
        echo "âœ… Image baseline construite avec succÃ¨s"

    - name: ðŸ“Š Mesurer les performances baseline
      run: |
        echo "ðŸ§ª ExÃ©cution des tests avec mÃ©triques de performance..."
        /usr/bin/time -v docker run --rm app:baseline npm test | tee baseline-metrics.log
        echo "âœ… Tests baseline terminÃ©s"

    - name: ðŸ“ˆ Analyser les mÃ©triques baseline
      run: |
        echo "ðŸ“Š Analyse des mÃ©triques baseline..."
        echo "=== MÃ‰TRIQUES BASELINE ===" > baseline-analysis.txt
        echo "Taille de l'image:" >> baseline-analysis.txt
        docker images app:baseline --format "table {{.Size}}" >> baseline-analysis.txt
        echo "" >> baseline-analysis.txt
        echo "DÃ©tails de l'image:" >> baseline-analysis.txt
        docker history app:baseline >> baseline-analysis.txt
        echo "âœ… Analyse baseline terminÃ©e"

    - name: ðŸ“¤ Upload mÃ©triques baseline
      uses: actions/upload-artifact@v4
      with:
        name: baseline-metrics
        path: |
          baseline-metrics.log
          baseline-analysis.txt

  optimized:
    name: ðŸš€ Build & Test - Image OptimisÃ©e
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Build image optimisÃ©e
      run: |
        echo "ðŸ”¨ Construction de l'image optimisÃ©e..."
        docker build -f Dockerfile.optimized -t app:optimized .
        echo "âœ… Image optimisÃ©e construite avec succÃ¨s"

    - name: ðŸ“Š Mesurer les performances optimisÃ©es
      run: |
        echo "ðŸ§ª ExÃ©cution des tests avec mÃ©triques de performance..."
        /usr/bin/time -v docker run --rm app:optimized npm test | tee optimized-metrics.log
        echo "âœ… Tests optimisÃ©s terminÃ©s"

    - name: ðŸ“ˆ Analyser les mÃ©triques optimisÃ©es
      run: |
        echo "ðŸ“Š Analyse des mÃ©triques optimisÃ©es..."
        echo "=== MÃ‰TRIQUES OPTIMISÃ‰ES ===" > optimized-analysis.txt
        echo "Taille de l'image:" >> optimized-analysis.txt
        docker images app:optimized --format "table {{.Size}}" >> optimized-analysis.txt
        echo "" >> optimized-analysis.txt
        echo "DÃ©tails de l'image:" >> optimized-analysis.txt
        docker history app:optimized >> optimized-analysis.txt
        echo "âœ… Analyse optimisÃ©e terminÃ©e"

    - name: ðŸ“¤ Upload mÃ©triques optimisÃ©es
      uses: actions/upload-artifact@v4
      with:
        name: optimized-metrics
        path: |
          optimized-metrics.log
          optimized-analysis.txt

  report:
    name: ðŸ“‹ GÃ©nÃ©ration du rapport de comparaison
    runs-on: ubuntu-latest
    needs: [baseline, optimized]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¥ Download mÃ©triques baseline
      uses: actions/download-artifact@v4
      with:
        name: baseline-metrics
        path: ./baseline-data

    - name: ðŸ“¥ Download mÃ©triques optimisÃ©es
      uses: actions/download-artifact@v4
      with:
        name: optimized-metrics
        path: ./optimized-data

    - name: ðŸ³ Build les deux images pour comparaison
      run: |
        echo "ðŸ”¨ Reconstruction des images pour comparaison..."
        docker build -f Dockerfile.baseline -t app:baseline .
        docker build -f Dockerfile.optimized -t app:optimized .
        echo "âœ… Images reconstruites"

    - name: ðŸ“Š GÃ©nÃ©rer le rapport de comparaison
      run: |
        echo "ðŸ“‹ GÃ©nÃ©ration du rapport de comparaison..."
        
        # CrÃ©er le rapport
        cat > report.txt << 'EOF'
        ================================================
        ðŸš€ RAPPORT DE COMPARAISON GREEN DEVOPS
        ================================================
        
        ðŸ“… Date: $(date)
        ðŸ”„ Workflow: ${{ github.workflow }}
        ðŸ“ Commit: ${{ github.sha }}
        
        ================================================
        ðŸ“Š COMPARAISON DES TAILLES D'IMAGES
        ================================================
        EOF
        
        echo "" >> report.txt
        echo "ðŸŒ IMAGE BASELINE (Lourde):" >> report.txt
        docker images app:baseline --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" >> report.txt
        
        echo "" >> report.txt
        echo "ðŸš€ IMAGE OPTIMISÃ‰E:" >> report.txt
        docker images app:optimized --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" >> report.txt
        
        echo "" >> report.txt
        echo "================================================" >> report.txt
        echo "ðŸ“ˆ ANALYSE DÃ‰TAILLÃ‰E DES COUCHES" >> report.txt
        echo "================================================" >> report.txt
        
        echo "" >> report.txt
        echo "ðŸŒ HISTORIQUE BASELINE:" >> report.txt
        docker history app:baseline --format "table {{.CreatedBy}}\t{{.Size}}" >> report.txt
        
        echo "" >> report.txt
        echo "ðŸš€ HISTORIQUE OPTIMISÃ‰:" >> report.txt
        docker history app:optimized --format "table {{.CreatedBy}}\t{{.Size}}" >> report.txt
        
        echo "" >> report.txt
        echo "================================================" >> report.txt
        echo "âš¡ MÃ‰TRIQUES DE PERFORMANCE" >> report.txt
        echo "================================================" >> report.txt
        
        # Ajouter les mÃ©triques de performance si disponibles
        if [ -f "./baseline-data/baseline-metrics.log" ]; then
          echo "" >> report.txt
          echo "ðŸŒ MÃ‰TRIQUES BASELINE:" >> report.txt
          cat ./baseline-data/baseline-metrics.log >> report.txt
        fi
        
        if [ -f "./optimized-data/optimized-metrics.log" ]; then
          echo "" >> report.txt
          echo "ðŸš€ MÃ‰TRIQUES OPTIMISÃ‰ES:" >> report.txt
          cat ./optimized-data/optimized-metrics.log >> report.txt
        fi
        
        echo "" >> report.txt
        echo "================================================" >> report.txt
        echo "ðŸŽ¯ RECOMMANDATIONS" >> report.txt
        echo "================================================" >> report.txt
        echo "" >> report.txt
        echo "âœ… Utilisez l'image optimisÃ©e pour:" >> report.txt
        echo "   - DÃ©ploiements en production" >> report.txt
        echo "   - RÃ©duction des coÃ»ts de stockage" >> report.txt
        echo "   - AmÃ©lioration des temps de dÃ©ploiement" >> report.txt
        echo "   - SÃ©curitÃ© renforcÃ©e (utilisateur non-root)" >> report.txt
        echo "" >> report.txt
        echo "âš ï¸  L'image baseline peut Ãªtre utilisÃ©e pour:" >> report.txt
        echo "   - DÃ©veloppement et debugging" >> report.txt
        echo "   - Tests nÃ©cessitant des outils de dev" >> report.txt
        echo "" >> report.txt
        echo "================================================" >> report.txt
        echo "ðŸ“Š RÃ‰SUMÃ‰" >> report.txt
        echo "================================================" >> report.txt
        
        # Calculer les diffÃ©rences de taille
        BASELINE_SIZE=$(docker images app:baseline --format "{{.Size}}")
        OPTIMIZED_SIZE=$(docker images app:optimized --format "{{.Size}}")
        
        echo "Taille baseline: $BASELINE_SIZE" >> report.txt
        echo "Taille optimisÃ©e: $OPTIMIZED_SIZE" >> report.txt
        echo "" >> report.txt
        echo "ðŸŽ‰ L'optimisation Docker amÃ©liore significativement:" >> report.txt
        echo "   - La taille de l'image finale" >> report.txt
        echo "   - Les temps de build et dÃ©ploiement" >> report.txt
        echo "   - La sÃ©curitÃ© et les bonnes pratiques" >> report.txt
        echo "" >> report.txt
        echo "================================================" >> report.txt
        echo "ðŸ Rapport gÃ©nÃ©rÃ© avec succÃ¨s!" >> report.txt
        echo "================================================" >> report.txt
        
        echo "âœ… Rapport gÃ©nÃ©rÃ©: report.txt"
        cat report.txt

    - name: ðŸ“¤ Upload rapport final
      uses: actions/upload-artifact@v4
      with:
        name: performance-report
        path: report.txt

    - name: ðŸ“‹ Afficher le rapport dans les logs
      run: |
        echo "ðŸ“‹ RAPPORT DE COMPARAISON GREEN DEVOPS"
        echo "======================================"
        cat report.txt
